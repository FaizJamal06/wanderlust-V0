<!DOCTYPE html>
<html lang="en">
  <head>
           <div>
         
         
    <title>Wanderlust</title>
  </head>
  <body>
    <% layout("layouts/boilerplate") %>

    <div class="listing-show container mt-4">
      <div class="row gx-4">
        <!-- Left column: images + details -->
        <div class="col-lg-8">
          <div class="gallery mb-3">
            <% let showImgSrc = '/images/placeholder.png'; %>
            <% if (listing.image && listing.image.url) { showImgSrc = listing.image.url; } else if (listing.image && listing.image.filename) { showImgSrc = '/uploads/' + listing.image.filename; } %>
            <div class="hero">
              <img src="<%= showImgSrc %>" alt="<%= listing.title %>" class="img-fluid rounded-3 w-100 hero-img" />
            </div>
          </div>

          <div class="card border-0 shadow-sm p-3 mb-4">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h2 class="mb-1"><%= listing.title %></h2>
                <div class="text-muted small"><i class="fas fa-map-marker-alt"></i> <%= listing.location %>, <%= listing.country %></div>
              </div>
              <div class="text-end">
                <div class="text-muted small">Hosted by</div>
                <div class="fw-bold"><%= listing.owner ? listing.owner.username : 'Unknown host' %></div>
              </div>
            </div>

            <hr />

            <h5>About this place</h5>
            <p class="text-muted"><%= listing.description %></p>

            <% if (listing.geometry && listing.geometry.coordinates && listing.geometry.coordinates.length === 2) { %>
              <div id="map" class="mb-3 rounded-3" style="height: 300px; width:100%;" data-coords="<%= listing.geometry.coordinates.join(',') %>"></div>
            <% } %>
          </div>
          <!-- Reviews -->
          <div class="card border-0 shadow-sm p-3 mb-4">
            <h5 class="mb-3">Reviews</h5>
            <% if (listing.reviews.length > 0) { %>
              <% listing.reviews.forEach((review) => { %>
                <div class="mb-3">
                  <div class="d-flex align-items-center mb-1">
                    <div class="me-2">
                      <% for(let i = 1; i <= 5; i++) { %>
                        <% if(i <= review.rating) { %>
                          <i class="fas fa-star text-warning"></i>
                        <% } else { %>
                          <i class="far fa-star text-muted"></i>
                        <% } %>
                      <% } %>
                    </div>
                    <div class="small text-muted"><%= new Date(review.createdAt).toLocaleDateString() %> â€” <%= review.author ? review.author.username : 'Anonymous' %></div>
                  </div>
                  <p class="mb-0 text-muted"><%= review.comment %></p>
                </div>
              <% }) %>
            <% } else { %>
              <div class="text-muted">No reviews yet.</div>
            <% } %>
          </div>
        </div>

        <% if (currentUser && listing.owner) { %>
          <% const isOwner = (currentUser._id && listing.owner._id) ? ((typeof currentUser._id.equals === 'function') ? currentUser._id.equals(listing.owner._id) : String(currentUser._id) === String(listing.owner._id)) : false; %>
          <% if (isOwner) { %>
            <div class="btns mt-4 mb-5">
              <div class="d-flex gap-2">
                <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary">
                  <i class="fas fa-edit me-2"></i>Edit
                </a>
                <form method="POST" action="/listings/<%=listing._id%>?_method=DELETE">
                  <button class="btn btn-danger">
                    <i class="fas fa-trash me-2"></i>Delete
                  </button>
                </form>
              </div>
            </div>
          <% } %>
        <% } %>
        <!-- Right column removed (booking/reservation UI) -->
      </div>
    </div>
  <% /* MapTiler: include CSS/JS and initialize map if coordinates present. Requires MAPTILER_API_KEY in environment. */ %>
  <% if (listing.geometry && listing.geometry.coordinates && listing.geometry.coordinates.length === 2) { %>
    <!-- MapTiler / MapLibre CSS & JS -->
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <script>
      (function() {
        // Read API key from server ENV via EJS
        const MAPTILER_KEY = '<%= process.env.MAPTILER_API_KEY ? process.env.MAPTILER_API_KEY : "" %>';
        if (!MAPTILER_KEY) {
          console.warn('MAPTILER_API_KEY not configured. Map will not load.');
          return;
        }
        // Read coords from DOM data attribute (format: "lng,lat")
        const mapEl = document.getElementById('map');
        if (!mapEl) return;
        const raw = mapEl.getAttribute('data-coords') || '';
        const parts = raw.split(',').map(Number);
        if (parts.length !== 2 || parts.some(isNaN)) return;
        const coords = parts; // [lng, lat]
        // coords are [lng, lat]
        const map = new maplibregl.Map({
          container: 'map',
          style: `https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`,
          center: coords,
          zoom: 12
        });
        // add marker
        new maplibregl.Marker().setLngLat(coords).addTo(map);
      })();
    </script>
  <% } %>
  </body>
</html>
